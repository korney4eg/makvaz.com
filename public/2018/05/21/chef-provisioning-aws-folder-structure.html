<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Makvaz  | Зачем chef provisioning пересоздал всё в AWS и как это поправить.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link rel="stylesheet" href="http://0.0.0:4000/css/blog.css" />
    
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="http://0.0.0:4000">Home</a>
            <a class="navbar-item" href="http://0.0.0:4000">About me</a>
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(http://0.0.0:4000/assets/img/header-pic.jpeg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Зачем chef provisioning пересоздал всё в AWS и как это поправить.
                    
                </h1>
            </div>

<p class="subtitle is-size-6 has-text-grey-light" align="center">
    21.05.2018 &middot;
</p>

        </div>
    </section>


<div class="container">
    <div class="section">
    
<div class="tags">

    <span class="tag"><a href="http://0.0.0:4000/tags/chef">chef</a></span>

    <span class="tag"><a href="http://0.0.0:4000/tags/aws">aws</a></span>

    <span class="tag"><a href="http://0.0.0:4000/tags/%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5">техническое</a></span>

</div>          
<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <p>Для того, что бы накатывать изминения в этот и некоторые другие сайты очень удобно пользоваться инструментами конфигурационного управления(Configuration Management tools), такими как OpsCode Chef, Puppet, RedHad Ansible. Мне ближе всего и удобнее использовать Chef потому что, это DSL к Ruby и код легко читается и пишется, а к тому же несколько лет назад был дополнен ещё надстройкой для создания и конфигурирования облачных ресурсов <a href="https://docs.chef.io/provisioning.html">Chef Provisioning</a>.</p>

<p>Понадобилось мне как-то кое-что поправить в конфигурации сайта с другого компьютера, и хотелось всё сделать правильно, тоесть в код прописать, закоммитить, нажать кнопку и всё чтобы стало хорошо. Залогинился я в консоль aws, создал там дополнительную пару ключей, потому как старая осталась на другом компе, к которому на тот момент доступа совершенно не было, и прописал эти ключи в aws config. Запустил <code>chef-client ...</code> и обалдел&hellip;</p>

<p>Не понятно почему, chef стал создавать все ресурсы (VPC, Internet Gateway, Subnets) заново, хотя такие уже существуют. Я полез, проверил конфиги - там всё правильно. Затем стал смотреть по статусу git, там тоже всё без изменений. Пошел в веб консоль, удалил новосозданные ресурсы и полез проверить структуру папок, не появилось ли чего нового. Оказалось, что появилось 2 новые папки: <em>nodes</em> и _data<em>bags</em>. Вот в этих папках и храниться метадата ресурсов, о которой будет несколько подробнее.</p>

<p>Как сказано в <a href="https://github.com/chef/chef-provisioning/blob/master/docs/faq.md">документации</a>, в <em>nodes</em> сохранятются все атрибуты о машинах, на которых запускался chef, в том числе и её id.</p>

<p>На cоставе данных в _data<em>bags</em> я бы хотел остановиться по-подробнее, потому что мне пришлось почти вручную воссоздавать структуру с нужными параметрами. Что из себя представляет эта дирректория:</p>

<h1 id="структура-data-bags">Структура _data<em>bags</em></h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">data_bags/
├── aws_internet_gateway
│   └── igw-managed-by-VPCID.json
├── aws_subnet
│   └── mysite_subnet.json
└── aws_vpc
    └── vpc-vpc.json</code></pre></div>
<h2 id="aws-vpc">aws_vpc</h2>

<p>Цель - хранение информации о VPC.
Посмотрим на файл <em>mysite-vpc.json</em> по-ближе:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;mysite-vpc&#34;</span>,
  <span style="color:#f92672">&#34;reference&#34;</span>: {
    <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;VPCID&#34;</span>
  },
  <span style="color:#f92672">&#34;driver_url&#34;</span>: <span style="color:#e6db74">&#34;aws:mysite:eu-central-1&#34;</span>
}</code></pre></div>
<p>, в котором:</p>

<p><strong>id</strong> - название vpc, записанное в рецепте создания инфраструктуры,</p>

<p><strong>reference.id</strong> - идентификатор vpc в AWS, вида <em>vpc-123abcde</em></p>

<p><strong>driver_url</strong> - строка драйвера для chef-provisioning, где <strong>aws</strong> - мы работаем с AWS, <strong>mysite</strong> - имя профиля конфигурации AWS, <strong>eu-central-1</strong> - регион AWS, где будет создаваться оборудование.</p>

<h2 id="aws-internet-gateway">aws_internet_gateway</h2>

<p>Как нетрудно догадаться из названия, здесь храниться настройки AWS internet gateway. Как устроен файл <em>igw-managed-by-VPCID.json</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;igw-managed-by-VPCID&#34;</span>,
  <span style="color:#f92672">&#34;reference&#34;</span>: {
    <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;VPCID&#34;</span>
  },
  <span style="color:#f92672">&#34;driver_url&#34;</span>: <span style="color:#e6db74">&#34;aws:vervedea:eu-central-1&#34;</span>
}</code></pre></div>
<p>Структурно, очень похоже на <em>mysite-vpc.json</em></p>

<p><strong>id</strong> - идентификатор, под которым chef-provisioning записал internet gateway</p>

<p>Всё остальное точно такое же, как и в конфиге VPC.</p>

<h2 id="aws-subnet">aws_subnet</h2>

<p>Ссылка на подсети.</p>

<p>_mysite<em>subnet.json</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;vervedea_subnet&#34;</span>,
  <span style="color:#f92672">&#34;reference&#34;</span>: {
    <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;subnet-7b93d410&#34;</span>
  },
  <span style="color:#f92672">&#34;driver_url&#34;</span>: <span style="color:#e6db74">&#34;aws:vervedea:eu-central-1&#34;</span>
}</code></pre></div>
<p><strong>id</strong> - идентификатор, под которым chef-provisioning записал подсеть (subnet)</p>

<p><strong>reference.id</strong> - идентификатор подсети в AWS, вида <strong>subnet-123abcde</strong></p>

<p><strong>driver_url</strong> - точно так же, как и в первом файле.</p>

<h1 id="вывод">Вывод</h1>

<p>Так как _data<em>bags</em> и <em>nodes</em> были сгенерированы chef-ом автоматически, я не стал их добавлять в репозиторий, думая, что в следующий раз они заново сгенерируются. Так и оказалось, просто были созданны новые ресурсы. В принципе нет никакой причины не добавлять _data<em>bags</em> и <em>nodes</em> в репозиторий, тем более, что такие конфигурации не храняться в публичных репозиториях.</p>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="http://0.0.0:4000/tags/ansible">ansible</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/aws">aws</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/bitwarden">bitwarden</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/blue-green-deployment">blue-green-deployment</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/canary-deployment">canary-deployment</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/chef">chef</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/ci/cd">ci/cd</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/deployment">deployment</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/devops">devops</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/git">git</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/howto">howto</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/opensource">opensource</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/passwordmanager">passwordmanager</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/tmux">tmux</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/vim">vim</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/%D0%BA%D0%BD%D0%B8%D0%B3%D0%B8">книги</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/%D0%BA%D1%83%D1%80%D1%81%D1%8B">курсы</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/%D0%BC%D1%8B%D1%81%D0%BB%D0%B8">мысли</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/%D1%81%D0%B0%D0%B9%D1%82">сайт</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D0%B8%D1%8F">сертификаия</a></span>
        
            <span class="tag"><a href="http://0.0.0:4000/tags/%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5">техническое</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="http://0.0.0:4000/2018/12/17/cources-recommendations.html">Где помогают освоить магию командной строки. Рекомендую курсы git и tmux</a></h1>
            <time class="has-text-grey-light is-size-7">17.12.2018</time>
        
            <h1><a href="http://0.0.0:4000/2018/12/10/password-managers.html">Выбираем open source менеджер паролей</a></h1>
            <time class="has-text-grey-light is-size-7">10.12.2018</time>
        
            <h1><a href="http://0.0.0:4000/2018/12/03/canary-deployment-with-ansible-on-aws.html">Пример бесперебойного развёртывания сервиса на Ansible в AWS. Часть 3. Canary Deployment</a></h1>
            <time class="has-text-grey-light is-size-7">03.12.2018</time>
        
            <h1><a href="http://0.0.0:4000/2018/11/26/rolling-deployment-with-anisble-with-aws.html">Пример бесперебойного развёртывания сервиса на Ansible в AWS. Часть 2. Rolling Deployment</a></h1>
            <time class="has-text-grey-light is-size-7">26.11.2018</time>
        
            <h1><a href="http://0.0.0:4000/2018/11/11/blue-green-deployment-with-anisble-with-aws.html">Пример бесперебойного развёртывания сервиса на Ansible в AWS. Часть 1. Blue-Green Deployment</a></h1>
            <time class="has-text-grey-light is-size-7">11.11.2018</time>
        
    </div>
</div>
    
<br>
                
  



<div class="card">
    <div class="card-content">
        <h1 class="title is-5">Related posts</h1>
      
      
            <h1><a href="http://0.0.0:4000/2018/12/03/canary-deployment-with-ansible-on-aws.html">Пример бесперебойного развёртывания сервиса на Ansible в AWS. Часть 3. Canary Deployment</a></h1>
            <time class="has-text-grey-light is-size-7">03.12.2018</time>
      
            <h1><a href="http://0.0.0:4000/2018/11/26/rolling-deployment-with-anisble-with-aws.html">Пример бесперебойного развёртывания сервиса на Ansible в AWS. Часть 2. Rolling Deployment</a></h1>
            <time class="has-text-grey-light is-size-7">26.11.2018</time>
      
            <h1><a href="http://0.0.0:4000/2018/11/11/blue-green-deployment-with-anisble-with-aws.html">Пример бесперебойного развёртывания сервиса на Ansible в AWS. Часть 1. Blue-Green Deployment</a></h1>
            <time class="has-text-grey-light is-size-7">11.11.2018</time>
      
            <h1><a href="http://0.0.0:4000/2018/08/25/aws-certification-preparation.html">Как подготовиться к сдаче на сертификат &#34;AWS Certified SysOps Administrator – Associate&#34;</a></h1>
            <time class="has-text-grey-light is-size-7">25.08.2018</time>
      
            <h1><a href="http://0.0.0:4000/2018/06/26/connection-simetimes-fails.html">Призрачная ошибка соединения</a></h1>
            <time class="has-text-grey-light is-size-7">26.06.2018</time>
      
    </div>
</div>

    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="http://0.0.0:4000/archives/2018">2018</a> (12)<br>
        
            <a href="http://0.0.0:4000/archives/2017">2017</a> (2)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://twitter.com/" class="mysocial"><i class="fab fa-twitter fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://www.youtube.com/" class="mysocial"><i class="fab fa-youtube fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://github.com/" class="mysocial"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://github.com/" class="mysocial"><i class="fab fa-instagram fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; Makvaz 2019 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
            - <a class="mysocial" href="http://0.0.0:4000/about">About</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
</body>
</html>
